# The `FROM` instruction specifies the base image. You are
# extending the `microsoft/aspnet` image.

FROM microsoft/aspnet:4.6.2

COPY . /inetpub/wwwroot

#Download status monitor
ADD http://go.microsoft.com/fwlink/?LinkID=522371&clcid=0x409 ApplicationInsightsAgent.msi

#Check status of msiserver
RUN powershell -NoProfile -Command \
	get-service -name msiserver;

#Check status of SM install
RUN powershell -NoProfile -Command \	
	$s = Get-ItemProperty "hklm:\SYSTEM\CurrentControlSet\Services\W3SVC"; \
	if ($s.Environment -eq $null) {Write-Host "Status Monitor Not Installed"} else {Write-Host "Status Monitor Installed"}
	
#Install status monitor
RUN msiexec /i ApplicationInsightsAgent.msi /qn

#Restart iis to take status monitor effect
RUN iisreset /restart

#Check status of SM install
RUN powershell -NoProfile -Command \	
	$s = Get-ItemProperty "hklm:\SYSTEM\CurrentControlSet\Services\W3SVC"; \
	if ($s.Environment -eq $null) {Write-Host "Status Monitor Not Installed"} else {Write-Host "Status Monitor Installed"}
	